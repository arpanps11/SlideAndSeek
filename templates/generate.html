<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generate Worship Slides</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f2f2f2;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section-selector, .section-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            padding: 6px 12px;
            margin: 5px 4px 0 0;
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005fa3;
        }
        .song-list {
            margin-top: 10px;
        }
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        .song-title {
            flex: 1;
        }
        .controls {
            display: flex;
            gap: 5px;
        }
        .home-button {
            text-align: center;
            margin-top: 30px;
        }
        .home-button a {
            text-decoration: none;
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border-radius: 5px;
        }
        .home-button a:hover {
            background-color: #111;
        }
        .section-box {
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .section-controls {
            text-align: right;
        }
    </style>
</head>
<body>
<h1>Generate Worship Slides</h1>

<form method="POST">
    <div class="section-selector">
        <label>Select Sections to Include (check to add):</label>
        <div><input type="checkbox" id="welcome_section"> Welcome Slide</div>
        <div><input type="checkbox" id="praise_section"> Praise and Worship</div>
        <div><input type="checkbox" id="opening_section"> Opening Hymn</div>
        <div><input type="checkbox" id="offertory_section"> Offertory Hymn</div>
        <div><input type="checkbox" id="communion_section"> Communion Hymn</div>
        <div><input type="checkbox" id="rr_section"> Responsive Reading</div>
        <div><input type="checkbox" id="extras_section"> Extras</div>
        <div><input type="checkbox" id="benediction_section"> Benediction</div>
    </div>

    <div id="sections" class="section-container"></div>

    <div style="text-align:center;">
        <button type="submit">Generate PowerPoint</button>
    </div>
</form>

<div class="home-button">
    <a href="/">← Back to Home</a>
</div>

<script>
    const sectionsContainer = document.getElementById('sections');
    const sectionsMap = {
        'welcome_section': 'Welcome Slide',
        'praise_section': 'Praise and Worship',
        'opening_section': 'Opening Hymn',
        'offertory_section': 'Offertory Hymn',
        'communion_section': 'Communion Hymn',
        'rr_section': 'Responsive Reading',
        'extras_section': 'Extras',
        'benediction_section': 'Benediction'
    };

    const songs = {{ songs|tojson }};
const rrs = {{ rrs|tojson }};


    function createSongSearchBox(name, selectedContainerId) {
        const wrapper = document.createElement('div');

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Search and select songs...';
        input.oninput = function () {
            const query = input.value.toLowerCase();
            results.innerHTML = '';
            songs.filter(song => song.title.toLowerCase().includes(query))
                .forEach(song => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = song.title;
                    btn.onclick = () => {
                        addSelectedSong(selectedContainerId, song, name);
                    };
                    results.appendChild(btn);
                });
        };

        const results = document.createElement('div');
        results.style.marginTop = '6px';

        wrapper.appendChild(input);
        wrapper.appendChild(results);
        return wrapper;
    }

    function addSelectedSong(containerId, song, inputName) {
        const container = document.getElementById(containerId);
        const exists = container.querySelector(`input[value="${song.id}"]`);
        if (exists) return;

        const item = document.createElement('div');
        item.className = 'song-item';

        const title = document.createElement('span');
        title.className = 'song-title';
        title.textContent = song.title;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = inputName;
        input.value = song.id;

        const up = document.createElement('button');
        up.textContent = '↑';
        up.onclick = () => {
            const prev = item.previousElementSibling;
            if (prev) container.insertBefore(item, prev);
        };

        const down = document.createElement('button');
        down.textContent = '↓';
        down.onclick = () => {
            const next = item.nextElementSibling;
            if (next) container.insertBefore(next, item);
        };

        const remove = document.createElement('button');
        remove.textContent = '✖';
        remove.onclick = () => container.removeChild(item);

        const controls = document.createElement('div');
        controls.className = 'controls';
        controls.append(up, down, remove);

        item.append(title, input, controls);
        container.appendChild(item);
    }

    function createRRDropdown() {
        const select = document.createElement('select');
        select.name = 'rr_id';
        rrs.forEach(rr => {
            const option = document.createElement('option');
            option.value = rr.id;
            option.textContent = `Responsive Reading ${rr.rr_number} - Psalm ${rr.psalm_number}`;
            select.appendChild(option);
        });
        return select;
    }

    function createSongDropdown(name) {
        const select = document.createElement('select');
        select.name = name;
        songs.forEach(song => {
            const option = document.createElement('option');
            option.value = song.id;
            option.textContent = song.title;
            select.appendChild(option);
        });
        return select;
    }

    function createSectionBox(id) {
        const box = document.createElement('div');
        box.className = 'section-box';
        box.dataset.sectionId = id;

        const title = document.createElement('h3');
        title.textContent = sectionsMap[id];
        box.appendChild(title);

        if (id === 'welcome_section') {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'welcome_text';
            input.placeholder = 'Welcome to the Worship Service';
            box.appendChild(input);
        } else if (id === 'praise_section') {
            const searchBox = createSongSearchBox('praise_ids[]', 'praise_selected');
            const listContainer = document.createElement('div');
            listContainer.id = 'praise_selected';
            listContainer.className = 'song-list';
            box.append(searchBox, listContainer);
        } else if (['opening_section', 'offertory_section', 'communion_section'].includes(id)) {
            const select = createSongDropdown(id.replace('_section', '_id'));
            box.appendChild(select);
        } else if (id === 'rr_section') {
            const select = createRRDropdown();
            box.appendChild(select);
        } else if (id === 'extras_section') {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'extras_title';
            input.placeholder = 'Enter Extras Section Title';
            box.appendChild(input);

            const searchBox = createSongSearchBox('extras_ids[]', 'extras_selected');
            const listContainer = document.createElement('div');
            listContainer.id = 'extras_selected';
            listContainer.className = 'song-list';
            box.append(searchBox, listContainer);
        } else if (id === 'benediction_section') {
            const p = document.createElement('p');
            p.textContent = 'This section will include two fixed Benediction slides.';
            box.appendChild(p);
        }

        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'section_order[]';
        hidden.value = id;

        const controls = document.createElement('div');
        controls.className = 'section-controls';

        const up = document.createElement('button');
        up.type = 'button';
        up.textContent = '↑';
        up.onclick = () => {
            const prev = box.previousElementSibling;
            if (prev) sectionsContainer.insertBefore(box, prev);
        };

        const down = document.createElement('button');
        down.type = 'button';
        down.textContent = '↓';
        down.onclick = () => {
            const next = box.nextElementSibling;
            if (next) sectionsContainer.insertBefore(next, box);
        };

        controls.append(up, down);
        box.append(hidden, controls);

        return box;
    }

    Object.keys(sectionsMap).forEach(id => {
        document.getElementById(id).addEventListener('change', function () {
            const exists = [...sectionsContainer.children].find(div => div.dataset.sectionId === id);
            if (this.checked && !exists) {
                const box = createSectionBox(id);
                sectionsContainer.appendChild(box);
            } else if (!this.checked && exists) {
                sectionsContainer.removeChild(exists);
            }
        });
    });
</script>
</body>
</html>
