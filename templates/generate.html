
<!DOCTYPE html>
<html>
<head>
    <title>Generate Worship Slides</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #fdfaf6;
            color: #2c3e50;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #34495e;
        }
        form {
            margin-top: 20px;
        }
        label, select, input {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .section-container {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #ffffff;
        }
        .song-search {
            margin-top: 10px;
        }
        button {
            background-color: #2c3e50;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
        }
        button:hover {
            background-color: #1f2d3a;
        }
        .chosen-song {
            background-color: #ecf0f1;
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .extra-fields {
            margin-top: 10px;
        }
    </style>
    <script>
        let allSongs = {};
        let selectedSections = [];

        async function fetchSongs() {
            const response = await fetch('/search?query=');
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const results = doc.querySelectorAll('li');
            results.forEach(li => {
                const title = li.dataset.title;
                const id = li.dataset.id;
                allSongs[title] = id;
            });
        }

        function isSingleSongSection(section) {
            return ["Opening Hymn", "Offertory Hymn", "Communion Hymn"].includes(section);
        }

        function addSectionUI() {
            selectedSections = Array.from(document.querySelectorAll('input[name="sections[]"]:checked')).map(i => i.value);
            const container = document.getElementById('sectionsArea');
            container.innerHTML = '';

            selectedSections.forEach(section => {
                const div = document.createElement('div');
                div.className = 'section-container';
                div.innerHTML = `<h3>${section}</h3>
                    <input type="text" placeholder="Search for song..." oninput="promptSong(this, '${section}')" list="songs-${section}" />
                    <datalist id="songs-${section}"></datalist>
                    <div id="${section}-songs-list"></div>`;
                container.appendChild(div);
            });
        }

        function promptSong(input, section) {
            const datalist = document.getElementById('songs-' + section);
            datalist.innerHTML = '';
            for (const title in allSongs) {
                if (title.toLowerCase().includes(input.value.toLowerCase())) {
                    const opt = document.createElement('option');
                    opt.value = title;
                    datalist.appendChild(opt);
                }
            }

            input.addEventListener('change', function () {
                const selectedId = allSongs[input.value];
                if (selectedId) {
                    const songList = document.getElementById(section + '-songs-list');
                    const div = document.createElement('div');
                    div.className = 'chosen-song';
                    div.innerHTML = `<strong>${input.value}</strong>`;
                    songList.innerHTML = '';  // allow only one song for single-song sections
                    songList.appendChild(div);

                    const hiddenTitle = document.createElement('input');
                    hiddenTitle.type = 'hidden';
                    hiddenTitle.name = `${section}_songs[]`;
                    hiddenTitle.value = selectedId;
                    songList.appendChild(hiddenTitle);

                    if (isSingleSongSection(section)) {
                        const extraFields = document.createElement('div');
                        extraFields.className = 'extra-fields';
                        extraFields.innerHTML = `
                            <input type="text" name="${section}_number" placeholder="Song Number (optional)">
                            <input type="text" name="${section}_page" placeholder="Page Number (optional)">
                        `;
                        songList.appendChild(extraFields);
                    }

                    input.value = '';
                }
            });
        }

        window.onload = fetchSongs;
    </script>
</head>
<body>
    <h1>Generate Slides</h1>
    <form method="post">
        <label>Select Sections to Include:</label>
        <label><input type="checkbox" name="sections[]" value="Praise and Worship" onchange="addSectionUI()"> Praise and Worship</label>
        <label><input type="checkbox" name="sections[]" value="Opening Hymn" onchange="addSectionUI()"> Opening Hymn</label>
        <label><input type="checkbox" name="sections[]" value="Responsive Reading" onchange="addSectionUI()"> Responsive Reading</label>
        <label><input type="checkbox" name="sections[]" value="Offertory Hymn" onchange="addSectionUI()"> Offertory Hymn</label>
        <label><input type="checkbox" name="sections[]" value="Communion Hymn" onchange="addSectionUI()"> Communion Hymn</label>
        <label><input type="checkbox" name="sections[]" value="Extras" onchange="addSectionUI()"> Extras</label>
        <label><input type="checkbox" name="sections[]" value="Benediction" onchange="addSectionUI()"> Benediction</label>

        <div id="sectionsArea"></div>
        <button type="submit">Generate PPTX</button>
    </form>
</body>
</html>
